# See: https://qiita.com/oshin/items/0d011610238eb4df83fd

version: '2'
services:
  nginx:
    image: nginx:1.13.8
    ports:
      - "8080:8080"
    volumes:
      - ./web/conf:/etc/nginx/conf.d
      # - ./web/html:/var/www/html
      - ./client/dist:/var/www/html
      - ./server-node/images:/var/www/html/images
      - ./web/log:/var/log/nginx/
  db:
    image: mariadb:10.3.2
    expose:
     - "3306"
    ports:
     - "3306:3306"
    environment:
      # MYSQL_ROOT_PASSWORD: $MYAPP_DATABASE_PASSWORD
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      MYSQL_DATABASE: database_development
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    # volumes:
    #   - ./db:/var/lib/mysql

  # app:
  #   build: .
  #   environment:
  #     MYAPP_DATABASE_USERNAME: root
  #     MYAPP_DATABASE_PASSWORD: $MYAPP_DATABASE_PASSWORD
  #     MYAPP_DATABASE_HOST: db
  api:
    # extends:
    #   service: app
    image: node:8.9.3
    # command: node /myapp/index.js
    working_dir: /myapp
    env_file:
      - api-variables.env
    command: >
      /bin/sh -c "
        ./node_modules/.bin/sequelize db:seed:undo:all &&
        ./node_modules/.bin/sequelize db:migrate:undo:all  &&
        ./node_modules/.bin/sequelize db:seed:all &&
        ./bin/www
      "
    volumes:
      - ./server-node:/myapp
    # ports:
    #   - "3000:3000"
    expose:
      - "3000"
    links:
      - db
  # web:
  #   # extends:
  #   #   service: app
  #   image: node:8.9.3
  #   command: node /myapp/node_modules/.bin/http-server /myapp/dist -p 8000
  #   volumes:
  #     - ./client:/myapp
  #   ports:
  #     - "8000:8000"

volumes:
  db-data:
    driver: local
